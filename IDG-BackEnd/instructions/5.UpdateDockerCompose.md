# How to Update docker-compose.yaml to Include MySQL (MariaDB) and phpMyAdmin

Follow these steps to update your `docker-compose.yaml` for a full Laravel + MariaDB + phpMyAdmin stack, using your specified image, container, and volume names:

---

## 1. Update Your `docker-compose.yaml`

Replace your existing `docker-compose.yaml` content with the following (customize as needed):

```yaml
services:
  app:
    build: .
    image: <your-dockerhub-username>/my-app:latest
    container_name: my-app-container
    volumes:
      - ./:/var/www/html
      - node:/var/www/html/node_modules
      - laravel:/var/www/html/vendor
    # command: sh /var/www/html/start.sh
    ports:
      - 8000:80
    depends_on:
      - mysql
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PASSWORD: root
  mysql:
    image: mariadb:10.11.13
    container_name: mysql-my-app-container
    environment:
      MYSQL_ROOT_PASSWORD: root
      TZ: UTC
    command: --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"
    volumes:
      - mysql:/var/lib/mysql
    ports:
      - 3306:3306
  phpmyadmin:
    image: phpmyadmin:5.2.2
    container_name: phpmyadmin-my-app-container
    depends_on:
      - mysql
    environment:
      UPLOAD_LIMIT: 50M
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: root
    ports:
      - 8001:80
volumes:
  mysql:
    name: my-app-mysql
  node:
    name: my-app-node
  laravel:
    name: my-app-laravel
```

---

## 2. Build and Start All Services

In your project directory, run:

```sh
docker-compose up -d --build
```

This will build your custom app image and start the app, MySQL (MariaDB), and phpMyAdmin containers.

---

## 3. Access Your Services

- **Laravel App:** http://localhost:8000
- **phpMyAdmin:** http://localhost:8001  
  (Login with user: `root`, password: `root`)
- **MySQL (MariaDB):** Accessible internally as `mysql:3306` (from your app container)

---

## 4. Stop and Remove All Containers

To stop and clean up:

```sh
docker-compose down
```

---

## Notes

- Volumes are named for persistence and to avoid conflicts.
- The app service uses a custom start command (`sh /var/www/html/start.sh`).
- The `depends_on` ensures the app and phpMyAdmin wait for MySQL to be ready.
- You can customize environment variables as needed for your project.

---

## Creating a start.sh Script for Container Startup Commands

To automate your container's setup and startup tasks, create a `start.sh` script in your project root. This script will be executed when your container starts (as defined in your `docker-compose.yaml`).

Hereâ€™s an example `start.sh` you can use and adjust as needed:

```bash
composer install

npm install

# chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache

# npm run build

# php artisan key:generate

# php artisan optimize:clear 

apache2-foreground
```

- Place any commands you want to run on container startup in this script.
- You can uncomment or add commands as your project requirements change.
- The last line, `apache2-foreground`, keeps the Apache server running in the foreground, which is required for the container to stay alive.

**Usage:**  
Make sure your `docker-compose.yaml` references this script in the app service:

```yaml
command: sh /var/www/html/start.sh
```

This approach keeps your container setup flexible and easy to maintain.

# How Docker Compose Overrides Laravel .env Database Settings

When running your Laravel application with Docker Compose, the environment variables defined in your `docker-compose.yaml` file for the app service will override the corresponding values in your Laravel `.env` file inside the container. This means that even if you set database connection details in `.env`, the values provided in Docker Compose take precedence during runtime.

For example, if your `docker-compose.yaml` includes:

```yaml
services:
  app:
    # ...other config...
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PASSWORD: root
```

Then, inside the running container, Laravel will use:

- `DB_CONNECTION=mysql` (forces MySQL connection)
- `DB_HOST=mysql` (connects to the MySQL service container, not localhost)
- `DB_PASSWORD=root` (matches the MySQL root password set for the database container)

These values will override any settings for these variables in your `.env` file. This is a standard Docker feature: environment variables set at the container level always take precedence over those in files inside the container.

**Why is this important?**

- It ensures your application always connects to the correct database service and uses the right credentials, regardless of what is set in `.env`.
- It makes your setup more portable and consistent across different environments (development, CI, etc.), since the configuration is controlled by Docker Compose.
- You do not need to manually edit `.env` for database connection when using Docker Compose; just update the environment section in your YAML file as needed.


**Summary:**

- Docker Compose environment variables for the app service override Laravel `.env` database settings inside the container.
- The values you set in `docker-compose.yaml` (such as `DB_CONNECTION`, `DB_HOST`, and `DB_PASSWORD`) are what Laravel will use at runtime.

---

# Testing the Laravel Database Connection

After starting your containers, you can verify that Laravel can connect to the database by running the following command inside your app container:

```
docker compose exec app php artisan migrate
```

Select "Yes" if prompted to run migrations. then check the migration status with:

```
docker compose exec app php artisan migrate:status
```

If the connection is successful, you will see a table showing the status of your migrations. If there is a connection error, check your Docker Compose environment variables and database container logs.

Alternatively, you can test the connection with:

```
docker compose exec app php artisan db:show
```

This will display information about the connected database. (Requires Laravel 10.7+)


